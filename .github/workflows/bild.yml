name: Build and Security Scan

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  # 1. Проверка секретов (Gitleaks)
  secrets-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 2. Сборка Java приложения
  build:
    name: Build Java App
    runs-on: ubuntu-latest
    needs: secrets-scan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Build application
        run: mvn clean package -DskipTests

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: jar-artifact
          path: target/*.jar
          retention-days: 1

  # 3. Статический анализ кода (SAST)
  sast:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Run Semgrep
        run: |
          pipx install semgrep
          semgrep scan --config auto --sarif --output semgrep.sarif || true
      - name: Upload SARIF
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep.sarif

  # 4. Анализ зависимостей (SCA)
  sca:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Run OWASP Check
        run: mvn -B org.owasp:dependency-check-maven:check -Dnvd.api.key=${{ secrets.NVD_API_KEY }}
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: target/dependency-check-report.html

  # 5. Динамический анализ (DAST)
  dast-dynamic:
    name: ZAP DAST Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: jar-artifact
          path: target
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Start Application
        run: |
          nohup java -jar target/*.jar &
          sleep 30
      - name: ZAP Baseline Scan
        run: |
          chmod -R 777 .
          docker run --rm --network host -v $(pwd):/zap/wrk/:rw ghcr.io/zaproxy/zaproxy:stable \
          zap-baseline.py -t http://localhost:8080 -r zap-report.html -I || true
      - name: Upload DAST Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-report.html

  # 6. Сборка, проверка Docker и Push (НОВОЕ)
  docker-build-secure:
    name: Docker Build, Scan and Push
    runs-on: ubuntu-latest
    needs: [sast, sca, dast-dynamic] # Ждем завершения всех проверок кода
    permissions:
      contents: read
      packages: write # Право на публикацию в GitHub Packages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download JAR
        uses: actions/download-artifact@v4
        with:
          name: jar-artifact
          path: target

      # Проверка Dockerfile на ошибки (Linting)
      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile

      # Сборка локального образа для тестов
      - name: Build Docker image locally
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/my-app:${{ github.sha }} .

      # Сканирование образа на уязвимости (Trivy)
      - name: Run Trivy Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ghcr.io/${{ github.repository_owner }}/my-app:${{ github.sha }}'
          format: 'table'
          exit-code: '1' # ОСТАНОВИТЬ pipeline, если найдены уязвимости
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      # Если Trivy не нашел критических ошибок, логинимся и пушим
      - name: Login to GitHub Container Registry
        if: success()
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Docker image
        if: success()
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/my-app:${{ github.sha }}
          docker tag ghcr.io/${{ github.repository_owner }}/my-app:${{ github.sha }} ghcr.io/${{ github.repository_owner }}/my-app:latest
          docker push ghcr.io/${{ github.repository_owner }}/my-app:latest